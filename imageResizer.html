<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div style="max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ddd;">
        <h3>Resize Product Image</h3>
        <label for="productId">Product ID:</label>
        <input type="text" id="productId" placeholder="Enter Product ID"
            style="width: 100%; padding: 8px; margin-bottom: 10px;" />
        <button id="resizeBtn" style="padding: 10px 20px;">Resize Image</button>
        <div id="status" style="margin-top: 10px; font-weight: bold;"></div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import {
            getFirestore,
            collection,
            updateDoc,
            getDoc,
            getDocs,
            query,
            where,
            doc,
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import {
            getAuth,
            onAuthStateChanged,
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getStorage, ref, getDownloadURL, deleteObject, uploadBytes, getBytes } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDVRG9BKj8af4h0abdjz8Tab4pQRq0wzjM",
            authDomain: "panacea-admin.firebaseapp.com",
            projectId: "panacea-admin",
            storageBucket: "panacea-admin.appspot.com",
            messagingSenderId: "800826664196",
            appId: "1:800826664196:web:df61636a3b5a44bf6bdc51",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        async function resizeImageHandler() {
            const productId = document.getElementById('productId').value.trim();
            const status = document.getElementById('status');
            status.innerText = "";

            if (!productId) {
                status.innerText = "⚠️ Enter a Product ID.";
                return;
            }

            try {
                status.innerText = "Fetching product...";

                const productRef = doc(db, 'Products', productId);
                const productSnap = await getDoc(productRef);

                if (!productSnap.exists()) {
                    status.innerText = "❌ Product not found.";
                    return;
                }

                const data = productSnap.data();
                const imageUrl = data.imageUrl;

                // Extract the path from the URL - it includes "products/filename"
                const urlParts = imageUrl.split('/');
                const encodedPath = urlParts[urlParts.length - 1];
                const decodedPath = decodeURIComponent(encodedPath.split('?')[0]);
                // decodedPath will be "products/IMG_1268.webp"
                const imageRef = ref(storage, decodedPath);

                status.innerText = "Downloading image...";

                // Get the image data using Firebase Storage
                const imageBytes = await getBytes(imageRef);
                const blob = new Blob([imageBytes], { type: 'image/jpeg' });

                status.innerText = "Resizing image...";

                const resizedBlob = await resizeBlob(blob, 600, 600);

                await deleteObject(imageRef);
                await uploadBytes(imageRef, resizedBlob);
                const newUrl = await getDownloadURL(imageRef);

                await updateDoc(productRef, { imageUrl: newUrl });

                status.innerText = "✅ Image resized and updated!";
            } catch (err) {
                console.error(err);
                status.innerText = "❌ Error: " + err.message;
            }
        }

        function resizeBlob(blob, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const reader = new FileReader();

                reader.onload = e => {
                    img.src = e.target.result;
                };

                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(resized => {
                        if (resized) {
                            resolve(resized);
                        } else {
                            reject(new Error("Canvas conversion failed"));
                        }
                    }, blob.type || "image/jpeg", 0.9);
                };

                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Add event listener to the button
        document.getElementById('resizeBtn').addEventListener('click', resizeImageHandler);
    </script>
</body>

</html>